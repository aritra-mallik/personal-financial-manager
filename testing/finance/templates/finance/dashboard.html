<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Dashboard</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'finance/dashboard.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="{% if user_theme == 'light' %}light{% else %}dark{% endif %}">
<header>{% include 'core/header.html' %}</header>
<div style="display: flex; min-height: calc(100vh - 100px);">
{% include 'finance/sidebar.html' %}

{% if messages %}
<div id="popup-messages">
    {% for message in messages %}
        <div class="popup-message {{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
    </div>
{% endif %}

<main style="flex: 1; padding: 20px;">

    <div class="marquee">
        <span id="marquee-text">
        {% if last_transaction %}
            Last Transaction: 
            {% if last_transaction.category %}
                {{ last_transaction.category }} - 
            {% endif %}
            {{ user_currency }}{{ last_transaction.amount }} 
            on {{ last_transaction.date }}
        {% else %}
            <p>No transactions yet.</p>
        {% endif %}
        {% if due_expenses %}
            &nbsp;|&nbsp; Pending Expenses:
            {% for expense in due_expenses %}
                {{ expense.category }} - {{ user_currency }}{{ expense.amount }} (Due: {{ expense.next_due_date }})
                {% if not forloop.last %}, {% endif %}
            {% endfor %}
        {% endif %}
        </span>
    </div>

<div class="dashboard-container">
    <h1>üëã Welcome {{ user.username }}!</h1>

    <!-- Summary Boxes -->
    <div class="summary-container">
        <a href="{% url 'income_history' %}" class="summary-box income-box">
            <h3>Total Income</h3>
            <p>{{ user_currency }}{{ total_income }}</p>
        </a>
        <a href="{% url 'expense_log' %}" class="summary-box expense-box">
            <h3>Total Expense</h3>
            <p>{{ user_currency }}{{ total_expense }}</p>
        </a>
        <div class="summary-box balance-box">
            <h3>Balance</h3>
            <p>{{ user_currency }}{{ balance }}</p>
        </div>
    </div>

    <!-- Collapsible Transparent Upload Section -->
        <div class="upload-toggle-container">
        <button class="upload-toggle" type="button" onclick="toggleUpload()">
            <span id="upload-arrow">‚¨áÔ∏è</span> Upload Real Bank Statement CSV
        </button>

        <div class="upload-section" id="upload-section">
            <h2>Already have a CSV of a Real Bank Statement?</h2>
            <form method="POST" enctype="multipart/form-data" action="{% url 'upload_bank_statement' %}">
                {% csrf_token %}
                <label for="csv_file">Upload Real Bank Statement CSV (MAX limit: 1.5MB)</label>
                <input type="file" name="csv_file" accept=".csv" required>
                <button type="submit">Upload</button>
            </form>
        </div>
        </div>

    <!-- Charts -->
    <div class="chart-container">
        <canvas id="incomeExpenseChart"></canvas>
    </div>

    <div class="chart-container">
        <canvas id="monthlyTrendsChart"></canvas>
    </div>

    <div class="chart-container">
        <canvas id="categoryExpenseChart"></canvas>
    </div>
</div>

<!-- Chart.js Scripts -->
<script> 


    //hidden upload section toggle
    function toggleUpload() {
    const section = document.getElementById('upload-section');
    const arrow = document.getElementById('upload-arrow');
    const isOpen = section.classList.toggle('open');
    arrow.classList.toggle('rotate', isOpen);
    }

    // Marquee animation duration based on text width
    window.addEventListener("load", function() {
    const marquee = document.getElementById("marquee-text");
    const textWidth = marquee.offsetWidth; // pixel width of text
    const containerWidth = marquee.parentElement.offsetWidth;

    // duration formula ‚Üí longer text = longer duration
    const duration = (textWidth + containerWidth) / 50; // tweak "50" for speed factor

    marquee.style.animationDuration = duration + "s";
    });
    const months = {{ months|safe }};
    const incomeData = {{ income_data|safe }};
    const expenseData = {{ expense_data|safe }};
    const weeks = {{ weeks|safe }};
    const weeklyIncomeData = {{ weekly_income_data|safe }};
    const weeklyExpenseData = {{ weekly_expense_data|safe }};
    const categoryLabels = {{ category_labels|safe }};
    const categoryValues = {{ category_values|safe }};

    
    // Detect theme
    const isLight = document.body.classList.contains('light');

    // Common chart options
    function getChartOptions(titleText) {
        return {
            responsive: true,
            plugins: {
                legend: { labels: { color: isLight ? '#121212' : '#fff' } },
                title: { display: true, text: titleText, color: isLight ? '#121212' : '#fff' }
            },
            scales: {
                x: { ticks: { color: isLight ? '#121212' : '#fff' }, grid: { color: isLight ? '#eee' : '#333' } },
                y: { ticks: { color: isLight ? '#121212' : '#fff' }, grid: { color: isLight ? '#eee' : '#333' } }
            }
        };
    }

// Income vs Expense (Weekly - REAL DATA)
const ctx1 = document.getElementById('incomeExpenseChart').getContext('2d');
new Chart(ctx1, {
    type: 'bar',
    data: {
        labels: weeks,
        datasets: [
            {
                label: 'Income',
                data: weeklyIncomeData,
                backgroundColor: 'rgba(123, 47, 247, 0.7)',
                borderColor: 'rgba(123, 47, 247, 1)',
                borderWidth: 1
            },
            {
                label: 'Expense',
                data: weeklyExpenseData,
                backgroundColor: 'rgba(241, 7, 163, 0.7)',
                borderColor: 'rgba(241, 7, 163, 1)',
                borderWidth: 1
            }
        ]
    },
    options: getChartOptions('Income vs Expense (Weekly)')
});

// Monthly Trends (Line)
const ctx2 = document.getElementById('monthlyTrendsChart').getContext('2d');
new Chart(ctx2, {
    type: 'line',
    data: {
        labels: months,
        datasets: [
            {
                label: 'Income',
                data: incomeData,
                borderColor: 'rgba(123, 47, 247, 1)',
                backgroundColor: 'rgba(123, 47, 247, 0.3)',
                fill: true,
                tension: 0.3
            },
            {
                label: 'Expense',
                data: expenseData,
                borderColor: 'rgba(241, 7, 163, 1)',
                backgroundColor: 'rgba(241, 7, 163, 0.3)',
                fill: true,
                tension: 0.3
            }
        ]
    },
    options: getChartOptions('Monthly Trends')
});

// Category-wise Expense (Doughnut)
const ctx3 = document.getElementById('categoryExpenseChart').getContext('2d');
new Chart(ctx3, {
    type: 'doughnut',
    data: {
        labels: categoryLabels,
        datasets: [{
            data: categoryValues,
            backgroundColor: [
                'rgba(123, 47, 247, 0.7)',
                'rgba(241, 7, 163, 0.7)',
                'rgba(255, 193, 7, 0.7)',
                'rgba(76, 175, 80, 0.7)',
                'rgba(255, 87, 34, 0.7)',
                'rgba(96, 125, 139, 0.7)',
                'rgba(97, 74, 6, 0.7)',
                'rgba(82, 8, 75, 0.7)',
                'rgba(9, 133, 6, 0.7)',
                'rgba(16, 38, 185, 0.7)',
            ]
        }]
    },
    options: getChartOptions('Category-wise Expense')
});

</script>
</main>
</div>

<footer>{% include 'core/footer.html' %}</footer>
<script>
const canvas = document.getElementById('money-bg');
if (canvas) {
  const ctx = canvas.getContext('2d');

  function resize(){
    canvas.width = innerWidth * devicePixelRatio;
    canvas.height = innerHeight * devicePixelRatio;
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener('resize', resize);
  resize();

  class Bill {
    constructor(){ this.reset(); }
    reset(){
      this.x = Math.random()*innerWidth - 200;
      this.y = innerHeight + Math.random()*200;
      const speed = 1 + Math.random()*3;
      const angle = -Math.PI/3 + (Math.random()-0.5)*0.6;
      this.vx = Math.cos(angle)*speed;
      this.vy = Math.sin(angle)*speed;
      this.size = 40 + Math.random()*80;
      this.rotation = (Math.random()*2-1) * 0.5;
      this.spin = (Math.random()*2-1)*0.03;
      this.opacity = 0;
      this.life = 0;
      this.maxLife = 200 + Math.random()*200;
      this.color = `hsl(${100+Math.random()*60} 60% 40%)`;
    }
    update(){
      this.x += this.vx;
      this.y += this.vy;
      this.rotation += this.spin;
      this.life++;
      this.opacity = Math.min(1, this.life/30);
      if(this.life > this.maxLife - 40)
        this.opacity = Math.max(0, (this.maxLife - this.life)/40);
      if(this.x > innerWidth + 300 || this.y < -300 || this.life > this.maxLife)
        this.reset();
    }
    draw(){
      ctx.save();
      ctx.globalAlpha = this.opacity;
      ctx.translate(this.x, this.y);
      ctx.rotate(this.rotation);
      const w = this.size;
      const h = this.size * 0.55;
      ctx.fillStyle = this.color;
      ctx.strokeStyle = "#155d27";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.roundRect(-w/2, -h/2, w, h, 8);
      ctx.fill();
      ctx.stroke();
      ctx.fillStyle = "#0c2b0a";
      ctx.font = `${Math.round(h*0.6)}px serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("$", 0, 0);
      ctx.restore();
    }
  }

  // roundRect polyfill for older browsers
  if (!CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
      if (typeof r === 'number') r = {tl:r,tr:r,br:r,bl:r};
      this.beginPath();
      this.moveTo(x + r.tl, y);
      this.arcTo(x + w, y, x + w, y + h, r.tr);
      this.arcTo(x + w, y + h, x, y + h, r.br);
      this.arcTo(x, y + h, x, y, r.bl);
      this.arcTo(x, y, x + w, y, r.tl);
      this.closePath();
      return this;
    }
  }

  const bills = Array.from({length: 60}, _=> new Bill());

  function loop(){
    const isDark = document.body.classList.contains("dark");
    ctx.fillStyle = isDark ? "#000" : "#fff"; // black for dark mode, white for light
    ctx.fillRect(0,0,innerWidth,innerHeight);

    for (const b of bills){
      b.update();
      b.draw();
    }

    requestAnimationFrame(loop);
  }
  loop();
}
</script>
</body>
</html>
