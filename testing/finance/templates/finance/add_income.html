<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Add Income - Finance Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="{% static 'finance/styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="{% if user_theme == 'light' %}light{% else %}dark{% endif %}">
<header>{% include 'core/header.html' %}</header>
<div style="display: flex; min-height: calc(100vh - 100px);">
{% include 'finance/sidebar.html' %}

<!-- Django Messages -->
    {% if messages %}
    <div id="popup-messages">
        {% for message in messages %}
        <div class="popup-message {{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

<main style="flex: 1;">
    <h1 class="page-title">üí∞ Add Income</h1>

    <!-- Add Income Form -->
    <form method="POST" >
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Add Income</button>
    </form>
    <h2 style="text-align: center;">Already have a csv of Incomes to add? Upload it here ‚¨áÔ∏è</h2>
    <form method="POST" enctype="multipart/form-data" action="{% url 'upload_income_csv' %}" style="margin-bottom:20px; align-items: center;">
        {% csrf_token %}
        <label for="csv_file">Upload Income CSV (MAX limit: 1MB)</label>
        <input type="file" name="csv_file" accept=".csv" required>
        <button type="submit">Upload</button>
    </form>

    <div class="chart-placeholder">
        <canvas id="incomeChart"></canvas>
    </div>
</main>
</div>

<footer>{% include 'core/footer.html' %}</footer>

<script>
    //prediction of income
    document.addEventListener('DOMContentLoaded', function() {
        const nameField = document.getElementById('id_source');
        const categoryField = document.getElementById('id_category');

        nameField.addEventListener('blur', function() {
            const text = nameField.value.trim();
            if (text.length > 0) {
                fetch("{% url 'predict_income_category' %}?text=" + encodeURIComponent(text))
                    .then(response => response.json())
                    .then(data => {
                        if (data.category) {
                            for (let option of categoryField.options) {
                                if (option.text === data.category || option.value === data.category) {
                                    option.selected = true;
                                    break;
                                }
                            }
                        }
                    })
                    .catch(err => console.error("Prediction error:", err));
            }
        });
    });
    //---------------------------------------------------------------------------
    // Income Chart with Theming
    function getIncomeThemeColors() {
        const isDark = document.body.classList.contains("dark");
        return {
            text: isDark ? "#E0E0E0" : "#222",
            backgroundColors: [
                isDark ? "#00BFA6" : "#1ABC9C",
                isDark ? "#36A2EB" : "#2980B9",
                isDark ? "#cea540" : "#F1C40F",
                isDark ? "#FF6384" : "#E74C3C",
                isDark ? "#8E44AD" : "#9B59B6",
                isDark ? "#E67E22" : "#D35400",
                isDark ? "#077707" : "#27AE60",
                isDark ? "#0e108a" : "#34495E",
                isDark ? "#a91606" : "#C0392B",
                isDark ? "#07483b" : "#16A085",
                isDark ? "#95A5A6" : "#BDC3C7"
            ]
        };
    }

    function createIncomeChart() {
        const ctxIncome = document.getElementById('incomeChart').getContext("2d");
        const colors = getIncomeThemeColors();

        return new Chart(ctxIncome, {
            type: 'doughnut',
            data: {
                labels: {{ categories|safe }},
                datasets: [{
                    data: {{ chart_data|safe }},
                    backgroundColor: colors.backgroundColors
                }]
            },
            options: {
                plugins: {
                    legend: {
                        labels: {
                            color: colors.text,
                            font: { size: 14 }
                        }
                    },
                    title: {                       // ‚Üê Added chart header
                        display: true,
                        text: "üí∞ Income Breakdown by Categories",
                        color: colors.text,
                        font: { size: 25, weight: 'bold' },
                        padding: { top: 10, bottom: 20 }
                    }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // initialize
    let incomeChart = createIncomeChart();

    // re-render when theme changes
    document.addEventListener("themeChanged", () => {
        incomeChart.destroy();
        incomeChart = createIncomeChart();
    });

</script>

</body>
</html>
