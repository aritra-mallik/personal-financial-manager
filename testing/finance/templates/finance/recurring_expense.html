<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recurring Expense - Finance Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="{% static 'finance/styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="{% if user_theme == 'light' %}light{% else %}dark{% endif %}">
<header>{% include 'core/header.html' %}</header>
<div style="display: flex; min-height: calc(100vh - 100px);">
{% include 'finance/sidebar.html' %}

{% if messages %}
    <div id="popup-messages">
        {% for message in messages %}
        <div class="popup-message {{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
{% endif %}

<main style="flex: 1;">
    <h1 class="page-title">‚è±Ô∏è Recurring Expenses</h1>
    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}

        <button type="submit">Add Recurring Expense</button>
    </form>

    <h2>Current Recurring Expenses</h2>
    <table>
        <tr>
            <th>Expense</th>
            <th>Amount</th>
            <th>Frequency</th>
            <th>Category</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Actions</th>
        </tr>
        {% for exp in expenses %}
        <tr>
            <td>{{ exp.name }}</td>
            <td>{{ exp.amount }}</td>
            <td>{{ exp.frequency|title }}</td>
            <td>{{ exp.category }}</td>
            <td>{{ exp.start_date }}</td>
            <td>{{ exp.end_date|default:"‚Äî" }}</td>
            <td>
                <div class="action-buttons">
                    <button type="button" class="edit-button" onclick="toggleEditForm('exp-{{ exp.id }}')">‚úèÔ∏è Edit</button>
                    <form method="POST" action="{% url 'delete_recurring_expense' exp.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="delete-button" onclick="return confirm('Delete this expense?')">üóëÔ∏è Delete</button>
                    </form>
                </div>
            </td>
        </tr>
        <tr id="exp-{{ exp.id }}" style="display:none; background:#222;">
            <td colspan="7">
                <form method="POST" action="{% url 'edit_recurring_expense' exp.id %}">
                    {% csrf_token %}
                    <input type="text" name="name" value="{{ exp.name }}" required>
                    <input type="number" step="0.01" name="amount" value="{{ exp.amount }}" required>
                    <select name="frequency" required>
                        {% for val,label in exp.FREQUENCY_CHOICES %}
                            <option value="{{ val }}" {% if exp.frequency == val %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <select name="category" required>
                        {% for val,label in exp.CATEGORY_CHOICES %}
                            <option value="{{ val }}" {% if exp.category == val %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <input type="date" name="start_date" value="{{ exp.start_date|date:'Y-m-d' }}" required>
                    <input type="date" name="end_date" value="{{ exp.end_date|date:'Y-m-d' }}">
                    <button type="submit">üíæ Save</button>
                    <button type="button" onclick="toggleEditForm('exp-{{ exp.id }}')" class="delete-button">‚ùå Cancel</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>

    <div class="chart-placeholder" style="height:300px;">
        <canvas id="recExpenseChart"></canvas>
    </div>
</main>

</div>
<footer>{% include 'core/footer.html' %}</footer>

<script>
    //prediction of expenses
    document.addEventListener('DOMContentLoaded', function() {
        const nameField = document.getElementById('id_name');
        const categoryField = document.getElementById('id_category');

        nameField.addEventListener('blur', function() {
            const text = nameField.value.trim();
            if (text.length > 0) {
                fetch("{% url 'predict_expense_category' %}?text=" + encodeURIComponent(text))
                    .then(response => response.json())
                    .then(data => {
                        if (data.category) {
                            for (let option of categoryField.options) {
                                if (option.text === data.category || option.value === data.category) {
                                    option.selected = true;
                                    break;
                                }
                            }
                        }
                    })
                    .catch(err => console.error("Prediction error:", err));
            }
        });
    });
    //---------------------------------------------------------------------------
    function toggleEditForm(id) {
        let row = document.getElementById(id);
        row.style.display = (row.style.display === "none") ? "table-row" : "none";
    }
    function getRecExpenseThemeColors() {
        const isDark = document.body.classList.contains("dark");
        return {
            text: isDark ? "#E0E0E0" : "#222"
        };
    }

    function createRecExpenseChart() {
        const ctx = document.getElementById('recExpenseChart').getContext("2d");
        const colors = getRecExpenseThemeColors();

        return new Chart(ctx, {
            type: 'pie',
            data: {
                labels: {{ categories|safe }},
                datasets: [{
                    data: {{ chart_data|safe }},
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#00BFA6', '#8E44AD',
                        '#E67E22', '#077707ff', '#0e108aff', '#a91606ff'
                    ]
                }]
            },
            options: {
                plugins: { 
                    legend: { 
                        labels: { 
                            color: colors.text, 
                            font: { size: 14 } 
                        } 
                    } 
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // initialize
    let recExpenseChart = createRecExpenseChart();

    // re-render on theme change
    document.addEventListener("themeChanged", () => {
        recExpenseChart.destroy();
        recExpenseChart = createRecExpenseChart();
    });
</script>
</body>
</html>
